<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Checkout | Goodwife Cosmetics</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* minimal layout for checkout */
    .checkout-wrap{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;gap:24px;grid-template-columns:1fr 380px}
    .card{border:1px solid #eee;border-radius:16px;background:#fff}
    .card h2{margin:0;padding:16px 18px;border-bottom:1px solid #eee;font-size:20px}
    .card .body{padding:16px 18px}
    .field{display:grid;gap:6px;margin-bottom:14px}
    .field label{font-size:14px;color:#444}
    .field input,.field textarea{padding:12px 14px;border:1px solid #e5e5e5;border-radius:10px;font-size:15px;outline:none}
    .field textarea{min-height:90px;resize:vertical}
    .btn{border:0;padding:12px 16px;border-radius:999px;font-weight:600;cursor:pointer}
    .btn-primary{background:#111;color:#fff;width:100%}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .summary-line{display:flex;justify-content:space-between;margin:6px 0}
    .summary-items{display:grid;gap:10px}
    .line{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center}
    .line img{width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid #eee}
    .line .name{font-weight:600}
    .success{max-width:680px;margin:24px auto;padding:16px 18px;background:#ecfdf5;border:1px solid #10b981;color:#065f46;border-radius:12px}
    @media (max-width: 900px){.checkout-wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <section class="checkout-wrap">
    <!-- Shipping / Contact -->
    <div class="card">
      <h2>Shipping & Contact</h2>
      <div class="body">
        <form id="checkout-form">
          <div class="field">
            <label for="fullName">Full name</label>
            <input id="fullName" name="fullName" type="text" placeholder="e.g. Ama Mensah" required>
          </div>
          <div class="grid-2">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" placeholder="you@example.com" required>
            </div>
            <div class="field">
              <label for="phone">Phone</label>
              <input id="phone" name="phone" type="tel" placeholder="+233..." required>
            </div>
          </div>
          <div class="field">
            <label for="address">Address</label>
            <input id="address" name="address" type="text" placeholder="Street address" required>
          </div>
          <div class="grid-2">
            <div class="field">
              <label for="city">City</label>
              <input id="city" name="city" type="text" placeholder="Accra" required>
            </div>
            <div class="field">
              <label for="region">Region</label>
              <input id="region" name="region" type="text" placeholder="Greater Accra" required>
            </div>
          </div>
          <div class="field">
            <label for="notes">Order notes (optional)</label>
            <textarea id="notes" name="notes" placeholder="Any delivery instructions?"></textarea>
          </div>

          <button class="btn btn-primary" type="submit">Place order</button>
        </form>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="card">
      <h2>Your Order</h2>
      <div class="body">
        <div id="summary-items" class="summary-items"></div>
        <hr style="margin:12px 0;border:0;border-top:1px solid #eee">
        <div class="summary-line"><span>Subtotal</span><strong id="subtot">₵0.00</strong></div>
        <div class="summary-line"><span>Shipping</span><strong id="ship">₵20.00</strong></div>
        <div class="summary-line" style="font-size:18px"><span>Total</span><strong id="total">₵0.00</strong></div>
      </div>
    </div>
  </section>

  <div id="order-success" class="success" style="display:none"></div>

  <script>
(() => {
  const CURRENCY = "₵";
  const fmt = (n) => CURRENCY + Number(n || 0).toFixed(2);
  const ADMIN_EMAIL = "orders@goodwife.example"; // TODO: set real admin email
  const CART_KEY = "cart";
  const USER_KEY = "gw_current_user";

  // Fallback placeholder image (prevents broken icon)
  const PLACEHOLDER_IMG =
    'data:image/svg+xml;utf8,' +
    encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="100%" height="100%" fill="#f2f2f2"/><text x="50%" y="52%" font-size="14" fill="#999" text-anchor="middle" dominant-baseline="middle">No image</text></svg>'
    );

  // Helpers
  function getUser(){ try { return JSON.parse(localStorage.getItem(USER_KEY) || "null"); } catch { return null; } }
  function getCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); } catch { return []; } }
  function getProducts(){ try { return JSON.parse(localStorage.getItem("GW_PRODUCTS") || "[]"); } catch { return []; } }
  function findProduct(id){ return getProducts().find(p => p.id === id) || null; }

  // --- guard: must be logged in
  (function guard(){
    const u = getUser();
    if (!u) {
      const back = encodeURIComponent(location.href);
      location.href = "Sliding-Sign-In-Sign-Up-Form-master/login.html?redirect=" + back;
    }
  })();

  // --- render summary
  const cart  = getCart();
  const listEl = document.getElementById("summary-items");
  const subEl  = document.getElementById("subtot");
  const shipEl = document.getElementById("ship");
  const totEl  = document.getElementById("total");

  if (!cart.length) {
    listEl.innerHTML = `<div style="text-align:center;padding:18px;border:1px dashed #eee;border-radius:12px;">Your cart is empty.</div>`;
    subEl.textContent = fmt(0);
    shipEl.textContent = fmt(0);
    totEl.textContent  = fmt(0);
  } else {
    let subtotalRender = 0;
    listEl.innerHTML = cart.map(ci => {
      const p = findProduct(ci.id) || { name: "Item", image: "", price: 0 };
      const price = Number(p.price || 0);
      const qty   = Math.max(1, Number(ci.qty || 1));
      const line  = price * qty;
      subtotalRender += line;
      const img = p.image || PLACEHOLDER_IMG;

      return `
        <div class="line">
          <img src="${img}" alt="${(p.name || "Item").replace(/"/g, "&quot;")}"
               onerror="this.src='${PLACEHOLDER_IMG}'">
          <div>
            <div class="name">${p.name || "Item"}</div>
            <div>Qty: ${qty}</div>
          </div>
          <div>${fmt(line)}</div>
        </div>`;
    }).join("");

    const shippingRender = 20; // flat rate; change rule if needed
    subEl.textContent = fmt(subtotalRender);
    shipEl.textContent = fmt(shippingRender);
    totEl.textContent  = fmt(subtotalRender + shippingRender);
  }

  // --- prefill from user
  (function prefill(){
    const u = getUser(); if (!u) return;
    const full  = document.getElementById("fullName");
    const email = document.getElementById("email");
    if (u.username && full  && !full.value)  full.value  = u.username;
    if (u.email    && email && !email.value) email.value = u.email;
  })();

  // --- submission
  document.getElementById("checkout-form").addEventListener("submit", (e) => {
    e.preventDefault();

    const data = Object.fromEntries(new FormData(e.currentTarget).entries());
    const user = getUser();
    const freshCart = getCart();
    if (!freshCart.length) {
      alert("Your cart is empty.");
      return;
    }

    // Rebuild totals at submit time
    let subtotal = 0;
    const items = freshCart.map(ci => {
      const p = findProduct(ci.id) || {};
      const price = Number(p.price || 0);
      const qty   = Math.max(1, Number(ci.qty || 1));
      subtotal += price * qty;
      return {
        id: ci.id,
        name: p.name || "Item",
        price,
        qty,
        image: p.image || ""
      };
    });

    const shipping = 20; // or (subtotal > 300 ? 0 : 20)
    const order = {
      id: "GW" + Date.now(),
      date: new Date().toISOString(),
      user: { username: user?.username || "", email: user?.email || "" },
      contact: data,
      items,
      subtotal,
      shipping,
      total: subtotal + shipping
    };

    // Save for admin (local)
    try {
      const ORDERS_KEY = "gw_orders";
      const prev = JSON.parse(localStorage.getItem(ORDERS_KEY) || "[]");
      prev.unshift(order);
      localStorage.setItem(ORDERS_KEY, JSON.stringify(prev));
    } catch {}

    // Clear cart
    localStorage.setItem(CART_KEY, "[]");

    // Send to admin via mailto (opens email client)
    const body =
`New order: ${order.id}
Date: ${order.date}

Customer: ${order.user.username} (${order.user.email})
Full name: ${data.fullName}
Phone: ${data.phone}
Address: ${data.address}, ${data.city}, ${data.region}

Items:
${order.items.map(i => "- " + i.name + " x" + i.qty + " — " + fmt(i.price * i.qty)).join("\n")}

Subtotal: ${fmt(order.subtotal)}
Shipping: ${fmt(order.shipping)}
Total: ${fmt(order.total)}

Notes:
${data.notes || "(none)"}`;

    const mailto = "mailto:" + encodeURIComponent(ADMIN_EMAIL)
      + "?subject=" + encodeURIComponent("New order " + order.id)
      + "&body=" + encodeURIComponent(body);
    window.open(mailto, "_blank"); // best-effort

    // Redirect to Thank You page
    location.href = "thank-you.html?id=" + encodeURIComponent(order.id);
  });
})();
</script>
</body>
</html>
